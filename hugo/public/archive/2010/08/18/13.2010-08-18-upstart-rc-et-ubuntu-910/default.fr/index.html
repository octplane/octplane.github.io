<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Upstart, rc et Ubuntu 9.10 | oct.zoy.org</title>
<meta name="keywords" content="">
<meta name="description" content="Comme vous le savez peut-√™tre, la derni√®re version d&rsquo;Ubuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d&rsquo;Upstart (ca s&rsquo;appelle comme √ßa) par rapport √† rc.* sont multiples:
d√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, &hellip;) parall√©lisme du d√©marrage des d√©mons (li√© au premier point) monitoring des d√©mons et respawn lorsqu&rsquo;ils meurent pre/post-scripts facile √† rajouter configuration ais√©e Bref, √ßa √† l&rsquo;air cool.">
<meta name="author" content="map[image:http://img2.blogblog.com/img/b16-rounded.gif name:Oct url:http://www.blogger.com/profile/10969884152933508554?rel=author]">
<link rel="canonical" href="https://oct.zoy.org/archive/2010/08/18/13.2010-08-18-upstart-rc-et-ubuntu-910/default.fr/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.9ece5999c00778a03c710e924aee5d11de71124f4ac26fb1046ad663031d846b.css" integrity="sha256-ns5ZmcAHeKA8cQ6SSu5dEd5xEk9Kwm&#43;xBGrWYwMdhGs=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.e85ad0406048e8176e1c7661b25d5c69297ddfe41dc4124cf75ecb99a4f7b3d1.js" integrity="sha256-6FrQQGBI6BduHHZhsl1caSl93&#43;QdxBJM917LmaT3s9E="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://oct.zoy.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://oct.zoy.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://oct.zoy.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://oct.zoy.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://oct.zoy.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Upstart, rc et Ubuntu 9.10" />
<meta property="og:description" content="Comme vous le savez peut-√™tre, la derni√®re version d&rsquo;Ubuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d&rsquo;Upstart (ca s&rsquo;appelle comme √ßa) par rapport √† rc.* sont multiples:
d√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, &hellip;) parall√©lisme du d√©marrage des d√©mons (li√© au premier point) monitoring des d√©mons et respawn lorsqu&rsquo;ils meurent pre/post-scripts facile √† rajouter configuration ais√©e Bref, √ßa √† l&rsquo;air cool." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oct.zoy.org/archive/2010/08/18/13.2010-08-18-upstart-rc-et-ubuntu-910/default.fr/" /><meta property="article:section" content="archive" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Upstart, rc et Ubuntu 9.10"/>
<meta name="twitter:description" content="Comme vous le savez peut-√™tre, la derni√®re version d&rsquo;Ubuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d&rsquo;Upstart (ca s&rsquo;appelle comme √ßa) par rapport √† rc.* sont multiples:
d√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, &hellip;) parall√©lisme du d√©marrage des d√©mons (li√© au premier point) monitoring des d√©mons et respawn lorsqu&rsquo;ils meurent pre/post-scripts facile √† rajouter configuration ais√©e Bref, √ßa √† l&rsquo;air cool."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Archives",
      "item": "https://oct.zoy.org/archive/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Upstart, rc et Ubuntu 9.10",
      "item": "https://oct.zoy.org/archive/2010/08/18/13.2010-08-18-upstart-rc-et-ubuntu-910/default.fr/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Upstart, rc et Ubuntu 9.10",
  "name": "Upstart, rc et Ubuntu 9.10",
  "description": "Comme vous le savez peut-√™tre, la derni√®re version d\u0026rsquo;Ubuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d\u0026rsquo;Upstart (ca s\u0026rsquo;appelle comme √ßa) par rapport √† rc.* sont multiples:\nd√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, \u0026hellip;) parall√©lisme du d√©marrage des d√©mons (li√© au premier point) monitoring des d√©mons et respawn lorsqu\u0026rsquo;ils meurent pre/post-scripts facile √† rajouter configuration ais√©e Bref, √ßa √† l\u0026rsquo;air cool.",
  "keywords": [
    
  ],
  "articleBody": "Comme vous le savez peut-√™tre, la derni√®re version d‚ÄôUbuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d‚ÄôUpstart (ca s‚Äôappelle comme √ßa) par rapport √† rc.* sont multiples:\nd√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, ‚Ä¶) parall√©lisme du d√©marrage des d√©mons (li√© au premier point) monitoring des d√©mons et respawn lorsqu‚Äôils meurent pre/post-scripts facile √† rajouter configuration ais√©e Bref, √ßa √† l‚Äôair cool. J‚Äôy reviendrais √† la fin.\nTout a commenc√© quand lors du reboot d‚Äôune machine dev‚Äô √† Fotopedia, je constate qu‚Äôun d√©mon (un mongodb) a √©t√© kill√© -9 au lieu d‚Äô√™tre arr√™t√© normalement. Ce d√©mon √©tait g√©r√© par ‚Äúrunit‚Äù, un autre syst√®me de gestion de services qu‚Äôon utilise √† Fotop√©dia depuis longtemps pour pallier les faiblesses des scripts rc* (en particulier, √©crire les scripts pour init.d pour des d√©mons qui ne forkent pas est un d√©licieux cauchemar que je laisse √† l‚Äôexercice du lecteur). Bref, on utilisait runit, qui est super simple √† configurer : un script dans /etc/sv/mond√©mon/run un lien depuis /etc/service vers ce folder, on attends 5 secondes et le d√©mon d√©marre le syst√®me.\nVoyant que mon mongodb est KILL -9, j‚Äôenqu√™te, je fais des exp√©riences et je m‚Äôaper√ßois que visiblement, runit est aussi KILL -9 par le syst√®me lors du shutdown pour une raison que j‚Äôignore (oui, le d√©mon runit n‚Äôest pas tr√®s bavard sur ses conditions de vie et de mort).\nCa craint, surtout que mon mongo pourrait rester dans un √©tat inconsistent si on le tue trop violemment. En plus, il pose un lock sur le fs et refuse de d√©marrer s‚Äôil est encore l√† plus tard (donc en particulier si on le KILL -9).\nEn ne cherchant pas les origines de la mort violent de runit lors du shutdown, je commets ma premi√®re erreur.\nJ‚Äôexamine les alternatives, et je finis par me dire (et l√†, je commets ma deuxi√®me erreur, li√©e √† la premi√®re): Puisque c‚Äôest Upstart qui fait tourner runit sur mon Ubuntu (l√† pour le coup, je pense que c‚Äôest les packages de la distro qui font ca), et que j‚Äôutilise runit pour lancer mon mongodb, je vais faire tourner mon mongodb directement dans Runit. Comme dirait mon grand p√®re, moins y a de code, moins y a de bug.\nAussit√¥t dit, aussit√¥t fait, je r√©√©cris un partie des r√®gles Chef pour migrer d‚Äôun syst√®me √† l‚Äôautre, je migre les 12 mongos qu‚Äôon a en testing, je teste, √ßa marche (enfin, les d√©mons tournent dans Upstart sans trop de complication, mettent leurs logs au bon endroit et logrotatent correctement).\nFi√®rement, je reboote ma machine et au boot d‚Äôapr√®s, je m‚Äôaper√ßois que les mongodb ont √©t√© KILL√©s -9 lors du shutdown, encore une fois. Bref, quelque chose se moque de moi.\nJe rajoute du log dans mongodb, je recommence et je m‚Äôaper√ßois, vu les logs, que mongo s‚Äôarr√™te bien avant le reboot mais red√©marre quasi aussit√¥t sans jamais finir sa s√©quence de d√©marrage (et tout ca AVANT que la machine ne reboote). Au boot d‚Äôapr√®s, le mongodb qui a √©t√© interrompu violemment (puisque les logs le sont aussi) a pos√© son lock et mon nouveau d√©mon refuse de d√©marrer. Damned.\nJe me met donc √† rajouter des informations de d√©bug dans les post et les pr√©-scripts Upstart de mon d√©mon pour voir par exemple ce qui est en train de se passer sur la machine lors du deuxi√®me d√©marrage avant le reboot. Je m‚Äôaper√ßois avec horreur que le deuxi√®me d√©marrage du",
  "wordCount" : "940",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": {"image":"http://img2.blogblog.com/img/b16-rounded.gif","name":"Oct","url":"http://www.blogger.com/profile/10969884152933508554?rel=author"}
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://oct.zoy.org/archive/2010/08/18/13.2010-08-18-upstart-rc-et-ubuntu-910/default.fr/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "oct.zoy.org",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oct.zoy.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oct.zoy.org/" accesskey="h" title="oct.zoy.org (Alt + H)">
                <img src="https://oct.zoy.org/bandana.png" alt="logo" aria-label="logo"
                    height="30">oct.zoy.org</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oct.zoy.org/about" title="ü™û about">
                    <span>ü™û about</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/as-a-speaker" title="üì¢ speaker">
                    <span>üì¢ speaker</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/archives/" title="üï∞Ô∏è Post Archive">
                    <span>üï∞Ô∏è Post Archive</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/tags/" title="üîñ tags">
                    <span>üîñ tags</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/archive/" title="üï∏Ô∏è old stuff">
                    <span>üï∏Ô∏è old stuff</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://oct.zoy.org/">Home</a>&nbsp;¬ª&nbsp;<a href="https://oct.zoy.org/archive/">Archives</a></div>
    <h1 class="post-title">
      Upstart, rc et Ubuntu 9.10
    </h1>
    <div class="post-meta">5 min&nbsp;¬∑&nbsp;map[image:http://img2.blogblog.com/img/b16-rounded.gif name:Oct url:http://www.blogger.com/profile/10969884152933508554?rel=author]

</div>
  </header> 
  <div class="post-content"><p>Comme vous le savez peut-√™tre, la derni√®re version d&rsquo;Ubuntu int√®gre un syst√®me r√©volutionnaire de boot parall√®le pour remplacer les vieux scripts rc.* qui existent sur nos v√©n√©r√©s serveurs depuis bien longtemps. Sur le papier les avantages d&rsquo;Upstart (ca s&rsquo;appelle comme √ßa) par rapport √† rc.* sont multiples:</p>
<ul>
<li>d√©marrage/arr√™t des d√©mons conditionn√©s √† des √©v√®nements (r√©seau-up,d√©mon foo-d√©marr√©, &hellip;)</li>
<li>parall√©lisme du d√©marrage des d√©mons  (li√© au premier point)</li>
<li>monitoring des d√©mons et respawn lorsqu&rsquo;ils meurent</li>
<li>pre/post-scripts facile √† rajouter</li>
<li>configuration ais√©e</li>
</ul>
<p>Bref, √ßa √† l&rsquo;air cool. J&rsquo;y reviendrais √† la fin.</p>
<p>Tout a commenc√© quand lors du reboot d&rsquo;une machine dev&rsquo; √† Fotopedia, je constate qu&rsquo;un d√©mon (un mongodb) a √©t√© kill√© -9 au lieu d&rsquo;√™tre arr√™t√© normalement. Ce d√©mon √©tait g√©r√© par &ldquo;runit&rdquo;, un autre syst√®me de gestion de services qu&rsquo;on utilise √† Fotop√©dia depuis longtemps pour pallier les faiblesses des scripts rc* (en particulier, √©crire les scripts pour init.d pour des d√©mons qui ne forkent pas est un d√©licieux cauchemar que je laisse √† l&rsquo;exercice du lecteur). Bref, on utilisait runit, qui est super simple √† configurer : un script dans /etc/sv/mond√©mon/run un lien depuis /etc/service vers ce folder, on attends 5 secondes et le d√©mon d√©marre le syst√®me.</p>
<p>Voyant que mon mongodb est KILL -9, j&rsquo;enqu√™te, je fais des exp√©riences et je m&rsquo;aper√ßois que visiblement, runit est aussi KILL -9 par le syst√®me lors du shutdown pour une raison que j&rsquo;ignore (oui, le d√©mon runit n&rsquo;est pas tr√®s bavard sur ses conditions de vie et de mort).</p>
<p>Ca craint, surtout que mon mongo pourrait rester dans un √©tat inconsistent si on le tue trop violemment. En plus, il pose un lock sur le fs et refuse de d√©marrer s&rsquo;il est encore l√† plus tard (donc en particulier si on le KILL -9).</p>
<p>En ne cherchant pas les origines de la mort violent de runit lors du<!-- raw HTML omitted -->
shutdown, je commets ma premi√®re erreur.</p>
<p>J&rsquo;examine les alternatives, et je finis par me dire (et l√†, je commets ma deuxi√®me erreur, li√©e √† la premi√®re): Puisque c&rsquo;est Upstart qui fait tourner runit sur mon Ubuntu (l√† pour le coup, je pense que c&rsquo;est les packages de la distro qui font ca), et que j&rsquo;utilise runit pour lancer mon mongodb, je vais faire tourner mon mongodb directement dans Runit. Comme dirait mon grand p√®re, moins y a de code, moins y a de bug.</p>
<p>Aussit√¥t dit, aussit√¥t fait, je r√©√©cris un partie des r√®gles Chef pour migrer d&rsquo;un syst√®me √† l&rsquo;autre, je migre les 12 mongos qu&rsquo;on a en testing, je teste, √ßa marche (enfin, les d√©mons tournent dans Upstart sans trop de complication, mettent leurs logs au bon endroit et logrotatent correctement).</p>
<p>Fi√®rement, je reboote ma machine et au boot d&rsquo;apr√®s, je m&rsquo;aper√ßois que les mongodb ont √©t√© KILL√©s -9 lors du shutdown, encore une fois. Bref, quelque chose se moque de moi.</p>
<p>Je rajoute du log dans mongodb, je recommence et je m&rsquo;aper√ßois, vu les logs, que mongo s&rsquo;arr√™te bien avant le reboot mais red√©marre quasi aussit√¥t sans jamais finir sa s√©quence de d√©marrage (et tout ca AVANT que la machine ne reboote). Au boot d&rsquo;apr√®s, le mongodb qui a √©t√© interrompu violemment (puisque les logs le sont aussi) a pos√© son lock et mon nouveau d√©mon refuse de d√©marrer. Damned.</p>
<p>Je me met donc √† rajouter des informations de d√©bug dans les post et les pr√©-scripts Upstart de mon d√©mon pour voir par exemple ce qui est en train de se passer sur la machine lors du deuxi√®me d√©marrage avant le reboot. Je m&rsquo;aper√ßois avec horreur que le deuxi√®me d√©marrage du&lt;br Mongo a lieu en plein runlevel 6, alors que la machine est en plein shutdown et donc, normalement, que personne ne se lance.</p>
<p>Je finis par tomber sur la directive <em>respawn</em> que j&rsquo;avais incluse dans les scripts Upstart pour mongo. Le doute jaillit dans mon esprit; je la commente, je teste. Tout marche bien. L&rsquo;explication:</p>
<p>Sur Ubuntu 9.10, la gestion des runlevels et confi√©e √† &ldquo;rc&rdquo; qui est un des d√©mons g√©r√©s par Upstart. Lorsque la machine entre en runlevel 6, elle essaye de tuer tous les process avec un kill classique, celui-ci r√©ussit. Cependant, Upstart s&rsquo;aper√ßoit que mon mongodb vient d&rsquo;√™tre termin√© et le relance aussit√¥t. Quelques instants plus tard le runlevel 6 envoie un KILL -9 aux d√©mons qui n&rsquo;ont pas voulu s&rsquo;arr√™ter; tuant violemment le Mongo (et tout les d√©mons qui sont en respawn dans Upstart).</p>
<p>Morale num√©ro 1: j&rsquo;ai remplac√© <em>respawn</em> de Upstart par un monit qui fait pareil mais √† c√¥t√©. Comme monit est lanc√© par rc, lorsque la machine se shutdowne les d√©mons s&rsquo;arr√™tent correctement.</p>
<p>Morale num√©ro 2: J&rsquo;ai fini par modifier la conf Upstart de Runit qui pr√©cisait elle aussi <em>respawn</em>, ce param√®tre expliquait que runit ne terminait par correctement et que mes mongodbs √©taient aussi tu√©s violemment. En enlevant le respawn de runit, rc 6 peut tuer runit correctement, celui-ci peut donc tuer ses d√©mons enfants correctement et mes mongos sont proprement shutdown√©s. On peut donc bien utiliser runit (qui est quand m√™me un poil plus confort que upstart √† g√©rer).</p>
<p>Evidemment, une fois qu&rsquo;on r√©alise √ßa, il faut rollbacker TOUTE la configuration de startup et de monitoring de mes mongos et remigrer mes 12 mongos sur mon environnement de test. Ca n&rsquo;a pris que 30 minutes avec Chef.</p>
<p>Morale num√©ro 3: On dirait bien que l&rsquo;int√©gration d&rsquo;Upstart dans 9.10 n&rsquo;est pas compl√®tement finie. Je ne dirais pas pourrie parce que si j&rsquo;avais fait attention, j&rsquo;aurai pas perdu 2 jours, mais bon. Quand m√™me.</p>
<p>Au final, m√™me si c&rsquo;est relativement prometteur comme syst√®me, le fait que Canonical ait sortie la 9.10 pas compl√®tement int√©gr√©e dans upstart est manifestement un √©norme probl√®me.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://oct.zoy.org/">oct.zoy.org</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
