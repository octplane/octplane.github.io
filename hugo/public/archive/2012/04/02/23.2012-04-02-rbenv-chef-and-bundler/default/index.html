<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Rbenv, chef and bundler | oct.zoy.org</title>
<meta name="keywords" content="ruby">
<meta name="description" content="What we aim We&rsquo;re trying to use rbenv in our infrastructure in order to achieve the following multiple goals:
Use the latest REE ruby runtime Switch to Ruby 1.9 for chef Prepare the migration to rails 3 and Ruby 1.9 for the main web application So far, I&rsquo;ve managed to install rbenv system wide on the servers using Riot Games excellent cookbook. A simple:
require_recipe &#34;rbenv&#34; # Setup the rubies PICOR_RUBY=&#34;ree-1.">
<meta name="author" content="">
<link rel="canonical" href="https://oct.zoy.org/archive/2012/04/02/23.2012-04-02-rbenv-chef-and-bundler/default/">
<meta name="google-site-verification" content="y8HjH28HsDJmfXel6OVWYfVTlOaM5Y0qt1sSIu4ncXo">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.9ece5999c00778a03c710e924aee5d11de71124f4ac26fb1046ad663031d846b.css" integrity="sha256-ns5ZmcAHeKA8cQ6SSu5dEd5xEk9Kwm&#43;xBGrWYwMdhGs=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://oct.zoy.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://oct.zoy.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://oct.zoy.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://oct.zoy.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://oct.zoy.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script defer data-domain="oct.zoy.org" src="https://plausible.io/js/script.js"></script><meta property="og:title" content="Rbenv, chef and bundler" />
<meta property="og:description" content="What we aim We&rsquo;re trying to use rbenv in our infrastructure in order to achieve the following multiple goals:
Use the latest REE ruby runtime Switch to Ruby 1.9 for chef Prepare the migration to rails 3 and Ruby 1.9 for the main web application So far, I&rsquo;ve managed to install rbenv system wide on the servers using Riot Games excellent cookbook. A simple:
require_recipe &#34;rbenv&#34; # Setup the rubies PICOR_RUBY=&#34;ree-1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://oct.zoy.org/archive/2012/04/02/23.2012-04-02-rbenv-chef-and-bundler/default/" /><meta property="article:section" content="archive" />



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rbenv, chef and bundler"/>
<meta name="twitter:description" content="What we aim We&rsquo;re trying to use rbenv in our infrastructure in order to achieve the following multiple goals:
Use the latest REE ruby runtime Switch to Ruby 1.9 for chef Prepare the migration to rails 3 and Ruby 1.9 for the main web application So far, I&rsquo;ve managed to install rbenv system wide on the servers using Riot Games excellent cookbook. A simple:
require_recipe &#34;rbenv&#34; # Setup the rubies PICOR_RUBY=&#34;ree-1."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Archives",
      "item": "https://oct.zoy.org/archive/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Rbenv, chef and bundler",
      "item": "https://oct.zoy.org/archive/2012/04/02/23.2012-04-02-rbenv-chef-and-bundler/default/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Rbenv, chef and bundler",
  "name": "Rbenv, chef and bundler",
  "description": "What we aim We\u0026rsquo;re trying to use rbenv in our infrastructure in order to achieve the following multiple goals:\nUse the latest REE ruby runtime Switch to Ruby 1.9 for chef Prepare the migration to rails 3 and Ruby 1.9 for the main web application So far, I\u0026rsquo;ve managed to install rbenv system wide on the servers using Riot Games excellent cookbook. A simple:\nrequire_recipe \u0026#34;rbenv\u0026#34; # Setup the rubies PICOR_RUBY=\u0026#34;ree-1.",
  "keywords": [
    "ruby"
  ],
  "articleBody": "What we aim We‚Äôre trying to use rbenv in our infrastructure in order to achieve the following multiple goals:\nUse the latest REE ruby runtime Switch to Ruby 1.9 for chef Prepare the migration to rails 3 and Ruby 1.9 for the main web application So far, I‚Äôve managed to install rbenv system wide on the servers using Riot Games excellent cookbook. A simple:\nrequire_recipe \"rbenv\" # Setup the rubies PICOR_RUBY=\"ree-1.8.7-2012.02\" CHEF_RUBY=\"1.9.2-p318\" OPINL_RUBY=\"1.9.2-p318\" rbenv_ruby PICOR_RUBY rbenv_ruby CHEF_RUBY in a chef cookbook, automatically download and install these versions of Ruby in the system wide rbenv. Because I‚Äôm not ready to switch, I‚Äôm not yet setting up automatic rbenv switching:\n# File \"/home/apps/.rbenv-version\" do # owner \"apps\" # group \"apps\" # backup false # content PICOR_RUBY # end # File \"/root/.rbenv-version\" do # owner \"root\" # group \"root\" # backup false # content CHEF_RUBY # end But this should go in action as soon as things works ok.\nNext step, Gems Because Bundle has some kind of memory, you should not use it to deploy gems from a given user if you plan to deploy another gemset in another environement with the SAME user later.\nAt fotopedia, we use GEM_HOME and GEM_PATH to change gemset because it works and it‚Äôs really simple (for binaries, we use a combination of symlinks in /usr/local/bin and alternative selection provided by our Debian OS). So we actually install several gemset with the same user. The workaround to have bundler work correctly is to change its HOME when running. Ugly, but efficient:\nscript \"Bundle picor gems\" do interpreter \"bash\" user \"root\" cwd \"/tmp/\" environment rbenv_as_hash code \u003c\u003c-EOS # Discard previous forced state rm -rf .bundle export HOME=$PWD export RBENV_VERSION=ree-1.8.7-2012.02 rbenv exec gem list bundler | grep 'bundler' || gem install bundler cd /etc/bundler rbenv exec bundle install --shebang ruby-local-exec --binstubs /usr/local/picorstubs EOS action :nothing end This script is run when the Gemfile changes in /etc/bundler (our current location for the Picor gems). the gems chefs are installed almost the same way:\nscript \"Bundle chef gems\" do interpreter \"bash\" user \"root\" cwd \"/root/\" environment rbenv_as_hash code \u0026lt;\u0026lt;-EOS export RBENV_VERSION=ree-1.8.7-2012.02 rbenv execgem list bundler | grep 'bundler' || rbenv exec gem install bundler # Use this because bundle in path is 1.8 bundle rbenv exec bundle install --deployment --shebang ruby-local-exec --binstubs /usr/local/chefstubs EOS action :nothing end Once this has run, /usr/local/picotstubs contains the picor binary stubs ready to be used and the chefstubs the one for chef.\nNext Step. Rewiring daemons to use one gemset according to what I need. Once the stubs are there, this might be straighforward‚Ä¶\n",
  "wordCount" : "430",
  "inLanguage": "en",
  "datePublished": "0001-01-01T00:00:00Z",
  "dateModified": "0001-01-01T00:00:00Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://oct.zoy.org/archive/2012/04/02/23.2012-04-02-rbenv-chef-and-bundler/default/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "oct.zoy.org",
    "logo": {
      "@type": "ImageObject",
      "url": "https://oct.zoy.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://oct.zoy.org/" accesskey="h" title="oct.zoy.org (Alt + H)">
                <img src="https://oct.zoy.org/bandana.png" alt="logo" aria-label="logo"
                    height="30">oct.zoy.org</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://oct.zoy.org/about" title="ü™û about">
                    <span>ü™û about</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/as-a-speaker" title="üì¢ speaker">
                    <span>üì¢ speaker</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/archives/" title="üï∞Ô∏è Post Archive">
                    <span>üï∞Ô∏è Post Archive</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/tags/" title="üîñ tags">
                    <span>üîñ tags</span>
                </a>
            </li>
            <li>
                <a href="https://oct.zoy.org/archive/" title="üï∏Ô∏è old stuff">
                    <span>üï∏Ô∏è old stuff</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://oct.zoy.org/">Home</a>&nbsp;¬ª&nbsp;<a href="https://oct.zoy.org/archive/">Archives</a></div>
    <h1 class="post-title">
      Rbenv, chef and bundler
    </h1>
    <div class="post-meta">3 min

</div>
  </header> 
  <div class="post-content"><h4 id="what-we-aim">What we aim<a hidden class="anchor" aria-hidden="true" href="#what-we-aim">#</a></h4>
<p>We&rsquo;re trying to use <!-- raw HTML omitted -->rbenv<!-- raw HTML omitted --> in our infrastructure in order to achieve the following multiple goals:</p>
<ul>
<li>Use the latest REE ruby runtime</li>
<li>Switch to Ruby 1.9 for chef</li>
<li>Prepare the migration to rails 3 and Ruby 1.9 for the main web application</li>
</ul>
<p>So far, I&rsquo;ve managed to install rbenv system wide on the servers using <!-- raw HTML omitted -->Riot Games excellent cookbook<!-- raw HTML omitted -->. A simple:</p>
<pre tabindex="0"><code>require_recipe &#34;rbenv&#34;
# Setup the rubies
PICOR_RUBY=&#34;ree-1.8.7-2012.02&#34;
CHEF_RUBY=&#34;1.9.2-p318&#34;
OPINL_RUBY=&#34;1.9.2-p318&#34;

rbenv_ruby PICOR_RUBY
rbenv_ruby CHEF_RUBY
</code></pre><p>in a chef cookbook, automatically download and install these versions of Ruby in the system wide rbenv. Because I&rsquo;m not ready to switch, I&rsquo;m not yet setting up automatic rbenv switching:</p>
<pre tabindex="0"><code># File &#34;/home/apps/.rbenv-version&#34; do
#   owner &#34;apps&#34;
#   group &#34;apps&#34;
#   backup false
#   content PICOR_RUBY
# end

# File &#34;/root/.rbenv-version&#34; do
#   owner &#34;root&#34;
#   group &#34;root&#34;
#   backup false
#   content CHEF_RUBY
# end
</code></pre><p>But this should go in action as soon as things works ok.</p>
<h4 id="next-step-gems">Next step, Gems<a hidden class="anchor" aria-hidden="true" href="#next-step-gems">#</a></h4>
<p>Because <!-- raw HTML omitted -->Bundle<!-- raw HTML omitted --> has some <!-- raw HTML omitted -->kind of memory<!-- raw HTML omitted -->, you should not use it to <!-- raw HTML omitted -->deploy<!-- raw HTML omitted --> gems from a given user if you plan to deploy another gemset in another environement with the <!-- raw HTML omitted -->SAME<!-- raw HTML omitted --> user later.</p>
<p>At fotopedia, we use <code>GEM_HOME</code> and <code>GEM_PATH</code> to change gemset because it works and it&rsquo;s really simple (for binaries, we use a combination of symlinks in <code>/usr/local/bin</code> and <code>alternative</code> selection provided by our Debian OS). So we actually install several gemset with the same user. The workaround to have bundler work correctly is to change its HOME when running. Ugly, but efficient:</p>
<pre tabindex="0"><code>script &#34;Bundle picor gems&#34; do
  interpreter &#34;bash&#34;
  user &#34;root&#34;
  cwd  &#34;/tmp/&#34;
  environment rbenv_as_hash
  code &lt;&lt;-EOS
# Discard previous forced state
rm -rf .bundle
export HOME=$PWD
export RBENV_VERSION=ree-1.8.7-2012.02
rbenv exec gem list bundler | grep &#39;bundler&#39; || gem install bundler
cd /etc/bundler
rbenv exec bundle install --shebang ruby-local-exec --binstubs /usr/local/picorstubs
EOS
  action :nothing
end
</code></pre><p>This script is run when the Gemfile changes in <!-- raw HTML omitted -->/etc/bundler<!-- raw HTML omitted --> (our current location for the Picor gems).
the gems chefs are installed almost the same way:</p>
<pre tabindex="0"><code>script &#34;Bundle chef gems&#34; do
  interpreter &#34;bash&#34;
  user &#34;root&#34;
  cwd &#34;/root/&#34;
  environment rbenv_as_hash
  code &amp;lt;&amp;lt;-EOS
export RBENV_VERSION=ree-1.8.7-2012.02
rbenv execgem list bundler | grep &#39;bundler&#39; || rbenv exec  gem install bundler
# Use this because bundle in path is 1.8 bundle
rbenv exec bundle install --deployment --shebang ruby-local-exec --binstubs /usr/local/chefstubs
EOS
  action :nothing
end
</code></pre><p>Once this has run, <!-- raw HTML omitted -->/usr/local/picotstubs<!-- raw HTML omitted --> contains the picor binary stubs ready to be used and the <!-- raw HTML omitted -->chefstubs<!-- raw HTML omitted --> the one for chef.</p>
<p>Next Step. Rewiring daemons to use one gemset according to what I need. Once the stubs are there, this might be straighforward&hellip;</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://oct.zoy.org/tags/ruby/">ruby</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://oct.zoy.org/">oct.zoy.org</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
